<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <link rel="stylesheet" href="css/index.css">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
</head>
<body>
    <h1>Weilan</h1>
    <h2>Beijing Air Quality</h2>
    <h3>Admin Dashboard</h3>
    <h4 class="car">Console: -- </h4>

    <div class="fast-link">
        <h4>Fast Link</h4>
        <a class="btn" href="pm25.in" target="_blank">PM25.in</a>
        <a class="btn" href="http://www.young-0.com/airquality/index.php" target="_blank">Young-0</a>
        <a class="btn" href="https://cn.avoscloud.com/applist.html#/apps" target="_blank">AVOS</a>
    </div>

    <div class="input-wrap">
        <h4>Forecast Information</h4>
        <p>
            <input type="text" class="first" placeholder="First Forecast">
        </p>
        <p>
            <input type="text" class="second" placeholder="Second Forecast">
        </p>
        <span class='save-guess btn'>Change</span>
    </div>

    <div class="crawler">
        <h4>Crawler</h4>
        <span class='fuck btn'>Get and save the data</span>
    </div>
        
        

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/av-0.3.1.min.js"></script>
    <script>
        AV.initialize("2uu9d14470rpv39bb1178vsddmkdfgis13zfr2be0vyeuog8", "o33s1rvaukqedeforme8f10wegjv69rdw0wjoei2cuka4u9q");

        $('.save-guess').on('click', function () {
            var first = $('.first').val();
            var second = $('.second').val();

            var father = AV.Object.extend('guess');
            var son = new father();
            son.set('first', first);
            son.set('second', second);
            son.save(null, {
              success: function(data) {
                $('.car').html('预测数据保存成功.');
              },
              error: function(data, error) {
                $('.car').html('预测数据保存失败.');
              }
            });
        });

        $('.fuck').on('click', function () {
            fuckData();
        });

        function fuckData () {
            var array = [];
            var domArray = $('#alonso').contents().find('.gr2');

            domArray.each(function (index, el) {
                array.unshift(parseInt($(el).text()));
            });

            var father = AV.Object.extend('aqiChart');
            var son = new father();

            son.set('data', array);

            son.save(null, {
                success: function(data) {
                    $('.car').html('数据爬取成功，并已经存入数据库.');
                },
                error: function(data, error) {
                    $('.car').html('数据爬取失败.');
                }
            });
        }

        function createIframe () {
            $('iframe').remove();
            var iframe = document.createElement('iframe');
            iframe.setAttribute('id', 'alonso');
            iframe.src = 'http://www.young-0.com/airquality/index.php';
            iframe.onload = function(){
                fuckData();
            };
            document.body.appendChild(iframe);
        }

        setInterval(function () {
            createIframe();
        }, 1200000);

        $(document).ready(function() {
            createIframe();
        });
    </script>
</body>
</html>